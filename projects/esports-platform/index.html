<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Esports Arena - Main</title>
  <style>
    /* Restored original look with light premium polish */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color:#fff;
      -webkit-font-smoothing:antialiased;
    }

    .header { text-align:center; padding:22px 16px 6px; }
    .header h1{
      font-size:2.6rem;
      margin:0;
      background: linear-gradient(45deg,#ff6ec4,#7873f5);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle { margin-top:6px; color:#cbd5e1; font-size:0.95rem; }

    .topbar { max-width:1100px; margin:14px auto; padding:0 16px; display:flex; justify-content:flex-end; gap:8px; align-items:center; }
    .logout-btn{
      padding:6px 10px; border-radius:8px; border:none; background:#ef4444; color:#fff; font-weight:800; cursor:pointer;
    }

    .tabs { display:flex; gap:10px; justify-content:center; margin:10px 0; }
    .tab {
      padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03); cursor:pointer; font-weight:800;
    }
    .tab.active { box-shadow:0 8px 24px rgba(0,0,0,0.4); border-color: rgba(124,58,237,0.25); }

    .container { max-width:1100px; margin:18px auto; padding:0 16px 60px; }
    .section { display:none; animation:fadeIn .24s ease both; }
    .section.active { display:block; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }

    .section-title{ font-size:1.15rem; color:#c7d2fe; margin-bottom:12px; font-weight:800; display:flex; align-items:center; gap:10px; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }

    .card {
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.04);
      padding:14px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.45);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .card:hover { transform: translateY(-6px); box-shadow: 0 16px 36px rgba(0,0,0,0.55); }

    .card h3 { margin:0; color:#a78bfa; }
    .muted { color:#9fb0cf; margin-top:6px; font-size:0.92rem; }

    /* tournament card register badge + count */
    .reg-badge {
      display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px;
      background: linear-gradient(90deg,#7c3aed,#06b6d4); color:#041014; font-weight:900; cursor:pointer;
      border:none;
    }
    .count-pill {
      display:inline-block; margin-left:8px; padding:3px 8px; border-radius:999px; font-weight:800; color:#fff;
      background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.06); font-size:0.85rem;
    }

    /* players list clickable */
    .player-card { cursor:pointer; }

    /* schedule item */
    .schedule-card { display:flex; justify-content:space-between; align-items:center; gap:12px; }

    /* profile modal & registration modal (match page styles) */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; z-index:80 }
    .modal{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(92%,420px); background:#0f1724; border:1px solid rgba(255,255,255,0.04);
      border-radius:12px; padding:16px; z-index:90; display:none; box-shadow:0 18px 50px rgba(0,0,0,0.6);
    }
    .modal h3 { margin:0 0 10px; color:#dbeafe }
    .modal .row { display:flex; gap:8px; margin-top:8px; }
    .modal input { flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.05); background:transparent; color:#fff }
    .modal button { margin-top:10px; padding:10px; border-radius:8px; border:none; background: linear-gradient(90deg,#7c3aed,#06b6d4); color:#041014; font-weight:900; cursor:pointer; width:100%; }

    .close-btn { position:absolute; right:12px; top:10px; background:transparent; border:none; color:#9fb0cf; font-size:18px; cursor:pointer; }

    /* small success animation glow */
    .success-glow {
      animation: successGlow .9s ease forwards;
    }
    @keyframes successGlow {
      0% { box-shadow: 0 0 0 rgba(0,0,0,0); transform:translateY(-2px); }
      40% { box-shadow: 0 6px 26px rgba(6,182,212,0.12); transform:translateY(0); }
      100% { box-shadow:0 0 0 rgba(0,0,0,0); transform:none; }
    }

    /* small responsive touch */
    @media (max-width:600px){
      .grid{ grid-template-columns: 1fr; }
      .header h1{ font-size:2rem; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Esports Arena</h1>
    <div class="subtitle">Welcome ‚Äî manage players, view schedule & join tournaments</div>
  </header>

  <div class="topbar">
    <div id="playerInfo"></div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="tournaments" onclick="activate('tournaments')">üèÜ Tournaments</div>
    <div class="tab" data-tab="schedule" onclick="activate('schedule')">üìÖ Schedule</div>
    <div class="tab" data-tab="players" onclick="activate('players')">üë• Players</div>
    <div class="tab" data-tab="earnings" onclick="activate('earnings')">üí∞ Earnings</div>
    <div class="tab" data-tab="dashboard" onclick="activate('dashboard')">üìà Dashboard</div>
  </div>

  <main class="container">
    <!-- Tournaments -->
    <section id="tournaments" class="section active">
      <div class="section-title">üèÜ Tournaments</div>
      <div id="tournamentGrid" class="grid"></div>
    </section>

    <!-- Schedule -->
    <section id="schedule" class="section">
      <div class="section-title">üìÖ Schedule</div>
      <div id="scheduleList" class="grid"></div>
    </section>

    <!-- Players -->
    <section id="players" class="section">
      <div class="section-title">üë• Players</div>
      <div id="playersGrid" class="grid"></div>
    </section>

    <!-- Earnings -->
    <section id="earnings" class="section">
      <div class="section-title">üí∞ Earnings</div>
      <div id="earningsBox" class="card"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="section">
      <div class="section-title">üìà Dashboard</div>
      <div id="dashGrid" class="grid"></div>
    </section>
  </main>

  <!-- Profile modal -->
  <div class="overlay" id="profileOverlay" onclick="closeProfile()"></div>
  <div class="modal" id="profileModal" role="dialog" aria-modal="true">
    <button class="close-btn" onclick="closeProfile()">‚úï</button>
    <h3 id="profileName">Player</h3>
    <p id="profileRank">Rank:</p>
    <p id="profileWins">Wins:</p>
    <p id="profileTournaments">Tournaments:</p>
    <p id="profileMVP"></p>
    <button onclick="closeProfile()">Close</button>
  </div>

  <!-- Registration modal -->
  <div class="overlay" id="regOverlay" onclick="closeReg()"></div>
  <div class="modal" id="regModal" role="dialog" aria-modal="true">
    <button class="close-btn" onclick="closeReg()">‚úï</button>
    <h3 id="regTitle">Register for Tournament</h3>
    <div class="row">
      <input id="regPlayer" placeholder="Player Name"/>
      <input id="regTeam" placeholder="Team Name"/>
    </div>
    <button id="regSubmit">Join Tournament</button>
  </div>

  <script>
    // --- Compatibility & utilities ---
    function readSchedule(){
      try {
        const raw = localStorage.getItem('schedule');
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && typeof parsed === 'object') {
          return Object.values(parsed).map(v => {
            if (typeof v === 'string') {
              const parts = v.split(' - ');
              return parts.length === 2 ? { title: parts[0], time: parts[1] } : { title: v, time: '' };
            }
            if (v && typeof v === 'object') return { title: v.title || '', time: v.time || '' };
            return { title: String(v), time: '' };
          });
        }
      } catch (e) { return []; }
      // fallback
      try{
        const raw2 = localStorage.getItem('matches');
        if(raw2){ const p = JSON.parse(raw2); return Array.isArray(p) ? p : []; }
      }catch(e){}
      return [];
    }

    function ensureTournamentIds(list){
      // we will not change UI; keep simple IDs optional
      let changed = false;
      list.forEach(t => { if(!t.id){ t.id = 't_' + Math.random().toString(36).slice(2,8); changed=true; }});
      if(changed) localStorage.setItem('tournaments', JSON.stringify(list));
      return list;
    }

    // registrations stored as mapping: { "Tournament Name": [ {playerName,teamName,createdAt}, ... ] }
    function getRegistrationsMap(){
      try { return JSON.parse(localStorage.getItem('registrations') || '{}'); } catch(e){ return {}; }
    }
    function setRegistrationsMap(map){ localStorage.setItem('registrations', JSON.stringify(map)); }

    // compatibility: if old apps used array, convert to map
    function normalizeRegistrations(){
      try{
        const raw = localStorage.getItem('registrations');
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)){
          // convert array of objects with tournamentName -> map
          const map = {};
          parsed.forEach(r => {
            if(!r || !r.tournamentName) return;
            map[r.tournamentName] = map[r.tournamentName] || [];
            map[r.tournamentName].push({ playerName: r.playerName||'', teamName: r.teamName||'', createdAt: r.createdAt || Date.now() });
          });
          setRegistrationsMap(map);
          return map;
        }
        if(parsed && typeof parsed === 'object') return parsed;
      }catch(e){}
      return {};
    }

    // escape helper
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // toast (simple)
    function toast(msg){
      // small temporary visual: add success class to modal for one second if open
      console.log('toast:', msg);
      // fallback: use alert in very old browsers
      // But keep console-only so admin flow not interrupted
    }

    // --- UI activation ---
    function activate(tab){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => { if(t.dataset.tab === tab) t.classList.add('active'); });
    }

    // --- Loaders & rendering (keep existing logic intact) ---
    function loadTournaments(){
      let list = JSON.parse(localStorage.getItem('tournaments') || '[]');
      list = ensureTournamentIds(list);
      const regs = normalizeRegistrations(); // ensure map saved to localStorage if needed
      const grid = document.getElementById('tournamentGrid');
      if(!list.length){ grid.innerHTML = '<div class="card">No tournaments yet.</div>'; return; }
      grid.innerHTML = list.map(t => {
        const count = (regs[t.name] && regs[t.name].length) || 0;
        return `<div class="card">
          <h3>${esc(t.name)}</h3>
          <div class="muted">${esc(t.game||'')} ‚Ä¢ ${esc(t.format||'')}</div>
          <div class="muted">Prize: $${t.prize||0} ‚Ä¢ Entry: $${t.entry||0}</div>
          <div class="muted">${t.date?esc(t.date)+' ':''}${esc(t.time||'')}</div>
          <div style="margin-top:8px;">
            <button class="reg-badge" data-name="${esc(t.name)}">Register</button>
            <span class="count-pill" id="count_${encodeURIComponent(t.name)}">${count}</span>
          </div>
        </div>`; }).join('');
      // attach handlers
      grid.querySelectorAll('.reg-badge').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const nm = btn.getAttribute('data-name');
          openRegisterModal(nm);
        });
      });
    }

    function loadSchedule(){
      const arr = readSchedule();
      const grid = document.getElementById('scheduleList');
      if(!arr.length){ grid.innerHTML = '<div class="card">No upcoming matches.</div>'; return; }
      grid.innerHTML = arr.map(m => `<div class="card schedule-card">
        <div>
          <h3>${esc(m.title)}</h3>
          <div class="muted">${esc(m.date||'')} ${esc(m.time||'')}</div>
        </div>
        <div class="muted">${esc(m.time||'')}</div>
      </div>`).join('');
    }

    function loadPlayers(){
      const p = JSON.parse(localStorage.getItem('players') || '[]');
      const mvps = JSON.parse(localStorage.getItem('mvps') || '[]');
      const grid = document.getElementById('playersGrid');
      if(!p.length){ grid.innerHTML = '<div class="card">No players yet.</div>'; return; }
      grid.innerHTML = p.map(pl => `<div class="card player-card" data-name="${esc(pl.name)}">
        <h3>${esc(pl.name)} ${mvps.includes(pl.name)?'<span style="display:inline-block;margin-left:8px;padding:4px 8px;border-radius:999px;background:#ffd86b;color:#000;font-weight:800">MVP</span>':''}</h3>
        <div class="muted">Wins: ${pl.wins||0} ‚Ä¢ Tournaments: ${pl.tournaments||0} ‚Ä¢ Rank: ${esc(pl.rank||'')}</div>
      </div>`).join('');
      // attach profile click
      grid.querySelectorAll('.player-card').forEach(c => c.addEventListener('click', ()=> showProfile(c.dataset.name)));
    }

    function loadEarnings(){
      const e = JSON.parse(localStorage.getItem('earnings') || '{}');
      const box = document.getElementById('earningsBox');
      box.innerHTML = `<div class="card"><h3>Total Earnings</h3><div class="muted">Total: $${e.total||0}</div><div class="muted">This month: $${e.month||0}</div></div>`;
    }

    function loadDashboard(){
      const t = JSON.parse(localStorage.getItem('tournaments') || '[]');
      const p = JSON.parse(localStorage.getItem('players') || '[]');
      const m = readSchedule();
      const e = JSON.parse(localStorage.getItem('earnings') || '{}');
      const regs = normalizeRegistrations();
      const dash = document.getElementById('dashGrid');
      dash.innerHTML = `
        <div class="card"><h3>Total Tournaments</h3><div class="muted">${t.length}</div></div>
        <div class="card"><h3>Total Players</h3><div class="muted">${p.length}</div></div>
        <div class="card"><h3>Upcoming Matches</h3><div class="muted">${m.length}</div></div>
        <div class="card"><h3>Registrations</h3><div class="muted">${Object.keys(regs).reduce((s,k)=>s + (regs[k]||[]).length,0)}</div></div>
        <div class="card"><h3>Total Earnings</h3><div class="muted">$${e.total||0}</div></div>
      `;
    }

    // --- Profile modal ---
    function showProfile(name){
      const players = JSON.parse(localStorage.getItem('players') || '[]');
      const mvps = JSON.parse(localStorage.getItem('mvps') || '[]');
      const pl = players.find(x=>x.name===name);
      if(!pl) return;
      document.getElementById('profileName').innerText = pl.name;
      document.getElementById('profileRank').innerText = 'Rank: ' + (pl.rank||'');
      document.getElementById('profileWins').innerText = 'Wins: ' + (pl.wins||0);
      document.getElementById('profileTournaments').innerText = 'Tournaments: ' + (pl.tournaments||0);
      document.getElementById('profileMVP').innerHTML = mvps.includes(pl.name) ? '<div style="margin-top:8px;padding:6px 8px;border-radius:8px;background:#ffd86b;color:#000;font-weight:800;display:inline-block">üåü MVP Player</div>' : '';
      document.getElementById('profileOverlay').style.display='block';
      document.getElementById('profileModal').style.display='block';
    }
    function closeProfile(){
      document.getElementById('profileOverlay').style.display='none';
      document.getElementById('profileModal').style.display='none';
    }

    // --- Registration modal & flow ---
    let currentTournamentName = null;
    function openRegisterModal(tournamentName){
      currentTournamentName = tournamentName;
      document.getElementById('regTitle').innerText = 'Register for: ' + tournamentName;
      // prefill activePlayer if exists
      try{
        const active = JSON.parse(localStorage.getItem('activePlayer') || 'null');
        if(active && active.name) document.getElementById('regPlayer').value = active.name;
      }catch(e){}
      document.getElementById('regOverlay').style.display='block';
      document.getElementById('regModal').style.display='block';
      setTimeout(()=> document.getElementById('regPlayer').focus(),50);
    }
    function closeReg(){
      document.getElementById('regOverlay').style.display='none';
      document.getElementById('regModal').style.display='none';
      document.getElementById('regPlayer').value=''; document.getElementById('regTeam').value='';
    }

    function submitRegistration(){
      const player = document.getElementById('regPlayer').value.trim();
      const team = document.getElementById('regTeam').value.trim();
      if(!player || !team){ alert('Please enter Player Name and Team Name'); return; }
      // load map, add entry under tournament name
      const map = normalizeRegistrations();
      const arr = map[currentTournamentName] || [];
      arr.push({ playerName: player, teamName: team, createdAt: Date.now() });
      map[currentTournamentName] = arr;
      setRegistrationsMap(map);
      // add small success animation on modal then close
      const modal = document.getElementById('regModal');
      modal.classList.add('success-glow');
      setTimeout(()=> {
        modal.classList.remove('success-glow');
        closeReg();
      }, 700);
      // update counts and dashboard
      updateRegistrationCounts();
      loadDashboard();
    }

    function updateRegistrationCounts(){
      const regs = normalizeRegistrations();
      const grid = document.getElementById('tournamentGrid');
      // update all count-pill spans
      Object.keys(regs).forEach(name => {
        const el = document.getElementById('count_' + encodeURIComponent(name));
        if(el) el.textContent = regs[name].length;
      });
      // also set counts for tournaments that might have zero
      document.querySelectorAll('#tournamentGrid .card').forEach(card=>{
        const btn = card.querySelector('.reg-badge');
        if(!btn) return;
        const nm = btn.getAttribute('data-name');
        const el = document.getElementById('count_' + encodeURIComponent(nm));
        if(!el) {
          // append if missing
          const span = document.createElement('span');
          span.className = 'count-pill';
          span.id = 'count_' + encodeURIComponent(nm);
          span.textContent = (regs[nm] && regs[nm].length) || 0;
          btn.parentNode.appendChild(span);
        }
      });
    }

    // --- Logout (player) ---
    function logout(){
      localStorage.removeItem('activePlayer');
      // reflect UI
      renderPlayerInfo();
      loadDashboard();
    }

    // --- Initialization & live sync ---
    function renderPlayerInfo(){
      const el = document.getElementById('playerInfo');
      try{
        const active = JSON.parse(localStorage.getItem('activePlayer') || 'null');
        if(active && active.name){
          el.innerHTML = `üë§ <strong>${esc(active.name)}</strong> &nbsp; <button class="logout-btn" onclick="logout()">Logout</button>`;
        } else {
          el.innerHTML = `<span class="muted">Not logged in</span>`;
        }
      }catch(e){ el.innerHTML = `<span class="muted">Not logged in</span>`; }
    }

    function refreshAll(){
      loadTournaments();
      loadSchedule();
      loadPlayers();
      loadEarnings();
      loadDashboard();
      updateRegistrationCounts();
      renderPlayerInfo();
    }

    window.addEventListener('storage', (e)=>{
      // If registrations changed in other tab, update counts and admin will also see
      if(['tournaments','players','mvps','schedule','matches','earnings','registrations'].includes(e.key)){
        refreshAll();
      }
    });

    document.getElementById('regSubmit').addEventListener('click', submitRegistration);

    window.onload = function(){
      refreshAll();
      // gentle periodic refresh to catch changes in same tab
      setInterval(refreshAll, 1500);
    };

  </script>
</body>
</html>
